<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Processor - Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #3b82f6;
      --background-color: #f9fafb;
      --card-bg: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --border-radius: 8px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #818cf8;
        --primary-hover: #6366f1;
        --background-color: #111827;
        --card-bg: #1f2937;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --border-color: #374151;
      }
      
      body {
        background-color: var(--background-color);
        color: var(--text-primary);
      }
      
      .card {
        background-color: var(--card-bg);
        border-color: var(--border-color);
      }
      
      .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
      }
      
      .logs-output {
        background-color: #111827;
        color: #e5e7eb;
      }
    }
    
    body {
      background-color: var(--background-color);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    .navbar-brand {
      font-weight: 600;
    }
    
    .logs-container {
      height: calc(100vh - 180px);
      min-height: 400px;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .logs-output {
      height: 100%;
      overflow-y: auto;
      background-color: #1a1a1a;
      color: #f0f0f0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 1rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .log-line {
      padding: 2px 0;
    }
    
    .log-error {
      color: #f87171;
    }
    
    .log-warning {
      color: #fbbf24;
    }
    
    .log-info {
      color: #60a5fa;
    }
    
    .log-debug {
      color: #a3a3a3;
    }
    
    .btn-group {
      margin-bottom: 1rem;
    }
    
    .fixed-top-buttons {
      position: sticky;
      top: 0;
      background-color: var(--background-color);
      padding: 1rem 0;
      z-index: 100;
      border-bottom: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="fas fa-film me-2"></i>
        Media Processor
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/logs.html">Logs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/settings.html">Settings</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">
            <i class="fas fa-terminal me-2"></i>
            Live Logs
          </h2>
          <div class="btn-group">
            <button class="btn btn-primary" id="start-stream">
              <i class="fas fa-play me-1"></i> Start Stream
            </button>
            <button class="btn btn-outline-secondary" id="pause-stream">
              <i class="fas fa-pause me-1"></i> Pause
            </button>
            <button class="btn btn-outline-secondary" id="clear-logs">
              <i class="fas fa-eraser me-1"></i> Clear
            </button>
          </div>
        </div>
        <div class="card logs-container">
          <div class="logs-output" id="logs-output">
            <div class="text-center text-muted my-5">
              <i class="fas fa-info-circle fa-2x mb-3"></i>
              <p>Click "Start Stream" to begin viewing logs</p>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
            <label class="form-check-label" for="auto-scroll">Auto-scroll</label>
          </div>
          <div>
            <span class="badge bg-secondary text-light" id="log-status">
              Disconnected
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const logsOutput = document.getElementById('logs-output');
      const startStreamBtn = document.getElementById('start-stream');
      const pauseStreamBtn = document.getElementById('pause-stream');
      const clearLogsBtn = document.getElementById('clear-logs');
      const autoScrollToggle = document.getElementById('auto-scroll');
      const logStatus = document.getElementById('log-status');
      
      let eventSource = null;
      let isPaused = false;
      let logLines = [];
      let reconnectAttempts = 0;
      const maxLogLines = 1000;
      const maxReconnectAttempts = 5;
      
      function updateStatus(status, color) {
        logStatus.textContent = status;
        logStatus.className = `badge bg-${color} text-light`;
      }
      
      function scrollToBottom() {
        if (autoScrollToggle.checked && !isPaused) {
          logsOutput.scrollTop = logsOutput.scrollHeight;
        }
      }
      
      function formatLog(text) {
        // Add color based on log level
        if (text.includes('ERROR') || text.includes('CRIT')) {
          return `<div class="log-line log-error">${text}</div>`;
        } else if (text.includes('WARN')) {
          return `<div class="log-line log-warning">${text}</div>`;
        } else if (text.includes('INFO')) {
          return `<div class="log-line log-info">${text}</div>`;
        } else if (text.includes('DEBUG')) {
          return `<div class="log-line log-debug">${text}</div>`;
        } else {
          return `<div class="log-line">${text}</div>`;
        }
      }
      
      function addLogLine(text, isError = false) {
        // Create formatted HTML
        const formattedText = isError ? 
          `<div class="log-line log-error">${text}</div>` : 
          formatLog(text);
        
        // Add log line to the array
        logLines.push(formattedText);
        
        // Trim array if it exceeds max lines
        if (logLines.length > maxLogLines) {
          logLines = logLines.slice(logLines.length - maxLogLines);
          
          // Update display
          logsOutput.innerHTML = logLines.join('');
        } else {
          // Just append the new line
          logsOutput.insertAdjacentHTML('beforeend', formattedText);
        }
        
        scrollToBottom();
      }
      
      function startEventStream() {
        if (eventSource) {
          eventSource.close();
        }
        
        // Update UI
        isPaused = false;
        startStreamBtn.disabled = true;
        pauseStreamBtn.disabled = false;
        pauseStreamBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pause';
        updateStatus('Connecting...', 'warning');
        
        try {
          // Connect to the stream
          eventSource = new EventSource('/api/logs/stream');
          
          eventSource.onopen = function() {
            console.log('Log stream connected');
            updateStatus('Connected', 'success');
            reconnectAttempts = 0;
            
            // Clear existing content if empty
            if (logLines.length === 0) {
              logsOutput.innerHTML = '';
            }
            
            // Add connected message
            addLogLine('Connected to log stream');
          };
          
          eventSource.onmessage = function(event) {
            if (isPaused) return;
            
            try {
              const data = JSON.parse(event.data);
              
              if (data.type === 'log') {
                // Split multi-line logs
                const lines = data.message.split('\n');
                lines.forEach(line => {
                  if (line.trim()) {
                    addLogLine(line);
                  }
                });
              } else if (data.type === 'error') {
                addLogLine(data.message, true);
                console.error('Stream error:', data.message);
                
                // Only update status if it's a critical error
                if (data.message.includes('permission denied') || 
                    data.message.includes('failed') ||
                    data.message.includes('exited with code')) {
                  updateStatus('Error', 'danger');
                }
              } else if (data.type === 'heartbeat') {
                console.log('Heartbeat received:', data.message);
              }
            } catch (error) {
              console.error('Error parsing log data:', error);
              addLogLine(`Error parsing log data: ${error.message}`, true);
            }
          };
          
          eventSource.onerror = function(error) {
            console.error('Log stream error:', error);
            
            // Close the current connection
            eventSource.close();
            
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              updateStatus(`Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`, 'warning');
              addLogLine(`Connection error. Trying to reconnect (attempt ${reconnectAttempts}/${maxReconnectAttempts})...`, true);
              
              // Attempt to reconnect after a delay
              setTimeout(startEventStream, 3000);
            } else {
              updateStatus('Connection failed', 'danger');
              addLogLine('Failed to connect after multiple attempts. Please try again later.', true);
              startStreamBtn.disabled = false;
              pauseStreamBtn.disabled = true;
            }
          };
        } catch (error) {
          console.error('Error setting up EventSource:', error);
          updateStatus('Connection error', 'danger');
          addLogLine(`Failed to connect: ${error.message}`, true);
          startStreamBtn.disabled = false;
          pauseStreamBtn.disabled = true;
        }
      }
      
      function stopEventStream() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }
        
        // Update UI
        startStreamBtn.disabled = false;
        pauseStreamBtn.disabled = true;
        updateStatus('Disconnected', 'secondary');
        addLogLine('Disconnected from log stream', true);
      }
      
      // Button event handlers
      startStreamBtn.addEventListener('click', function() {
        // Clear current status if we're restarting
        if (reconnectAttempts >= maxReconnectAttempts) {
          reconnectAttempts = 0;
        }
        startEventStream();
      });
      
      pauseStreamBtn.addEventListener('click', function() {
        if (isPaused) {
          // Resume
          isPaused = false;
          pauseStreamBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pause';
          updateStatus('Connected', 'success');
          addLogLine('Log streaming resumed');
          scrollToBottom();
        } else {
          // Pause
          isPaused = true;
          pauseStreamBtn.innerHTML = '<i class="fas fa-play me-1"></i> Resume';
          updateStatus('Paused', 'warning');
          addLogLine('Log streaming paused');
        }
      });
      
      clearLogsBtn.addEventListener('click', function() {
        logsOutput.innerHTML = '';
        logLines = [];
        addLogLine('Logs cleared');
      });
      
      // Initial setup
      pauseStreamBtn.disabled = true;
      
      // Auto-start streaming when page loads
      startEventStream();
      
      // Handle page visibility changes
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
          // Page is now visible, check if we need to reconnect
          if (eventSource === null || eventSource.readyState === 2) { // CLOSED
            startEventStream();
          }
        }
      });
    });
  </script>
</body>
</html> 